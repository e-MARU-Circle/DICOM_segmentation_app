# Notionグラフ表示Webアプリ開発ログ (2025年8月9日) - Day 3

こんにちは！データベースとの連携で少し手こずりましたが、粘り強く解決できましたね。

## 本日のゴール
- 管理画面から入力したNotionの設定を、Supabaseデータベースに保存すること。

## 行った作業の詳細

### 1. Supabaseとの連携準備
- **やりたかったこと**: Next.jsアプリからSupabaseのデータベースを操作できるようにしたい。
- **何をしたか**:
    1.  **環境変数の設定**: SupabaseのプロジェクトURLとAPIキー(anon key)を、`.env.local`というファイルに保存しました。このファイルに書いておくと、Next.jsが自動で読み込んでくれます。APIキーのような秘密の情報をコードに直接書かないための、とても大事な手順です。
    2.  **Supabaseクライアントの作成**: アプリのどこからでも簡単にSupabaseを呼び出せるように、共通のクライアントファイル(`src/lib/supabaseClient.ts`)を作成しました。

### 2. 管理画面UIの作成
- **やりたかったこと**: Notionの設定項目（APIキーやデータベースIDなど）を入力できるフォーム画面を作りたい。
- **何をしたか**: `/admin`というURLでアクセスできるページ(`src/app/admin/page.tsx`)を作成し、ReactとTailwind CSSを使って、設定項目を入力するためのフォームを実装しました。

### 3. データベース保存処理と、それに伴うエラーとの格闘
- **やりたかったこと**: 管理画面のフォームで「保存」ボタンを押したら、入力内容がSupabaseの`settings`テーブルに保存されるようにしたい。
- **何をしたか**: `handleSubmit`という関数の中に、`supabase.from('settings').insert(...)`というコードを追加し、データベースへの書き込み処理を実装しました。

- **遭遇したエラーと解決策（ここが重要！）**:
    1.  **エラー① `Error inserting data: {}`**: 最初のエラー。具体的なメッセージがなく、原因が分かりにくいものでした。
        - **仮説**: Row Level Security (RLS) が原因ではないか？
        - **対策**: Supabaseのダッシュボードで、`settings`テーブルのRLSを有効にし、「誰でも全操作を許可する」というポリシーを追加しました。しかし、これだけでは解決しませんでした。

    2.  **エラー② `user_id`カラムへの書き込み**: 次に、`user_id`が空(null)のまま送られているのが原因ではないかと考えました。
        - **対策**: `crypto.randomUUID()`を使って、仮のIDを生成して`user_id`にセットするようにコードを修正しました。しかし、これも根本的な解決にはなりませんでした。

    3.  **エラー③ `Could not find the 'database_id' column ...`**: これが核心的なエラーメッセージでした。「`database_id`カラムが見つからない」という内容です。
        - **原因**: Supabaseの内部キャッシュが古くなっており、新しく作成したテーブルの構造を正しく認識できていない状態でした。これはSupabaseで時々起こる問題です。
        - **対策**: スキーマキャッシュを強制的にリロードする`NOTIFY pgrst, 'reload schema';`というSQLコマンドを実行しました。しかし、それでも解決しませんでした。

    4.  **最終的な解決策**: ここまでやっても解決しないということは、最初に作ったテーブル自体に何か問題があった可能性が高いと判断しました。
        - **対策**: 一度`settings`テーブルを完全に削除し、カラム名や型を正確に指定したSQLを使って**テーブルを再作成**しました。これにより、データベースの状態がクリーンになり、ようやくデータの保存に成功しました。

## 今日のまとめ
今日は、データベース連携における非常に実践的なトラブルシューティングを経験しました。エラーメッセージを注意深く読み、仮説を立て、一つずつ検証していくというデバッグの基本的な流れを体験できましたね。特にSupabaseのRLSやスキーマキャッシュは、知らないと解決が難しい問題です。この経験は、今後の開発で必ず活きてきます。

大きな壁を乗り越えたので、ここからはスムーズに進めていけるはずです。
次回は、いよいよ保存した設定を使って、**実際にNotion APIからデータを取得する処理**を実装していきます！

