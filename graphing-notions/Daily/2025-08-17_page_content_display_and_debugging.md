## 2025年8月17日：ページ内容表示機能の実装と格闘の記録

### はじめに：ページ内容表示機能の目標

今日の主な目標は、グラフのページノードをダブルクリック（現在はシングルクリックでデバッグ中）した際に、そのNotionページの内容を画面全体に表示する機能を実現することでした。

### 実装の道のり：数々の課題と解決

この機能は、イベントの検知、データの取得、画面レイアウトの変更、内容の表示という複数の要素が絡み合い、多くの課題に直面しました。

1.  **イベント検知の課題:**
    -   当初、ノードのクリックイベントが全く検知されない問題に直面しました。
    -   `3d-force-graph`のインスタンス管理方法を見直し、`useRef`を使ってインスタンスを永続化し、イベントリスナーを適切に設定することで、クリックイベントが正しく動作するようになりました。

2.  **画面表示の課題:**
    -   コンテンツパネルがグラフの裏に隠れてしまう問題が再発しました。
    -   `z-index`、`position`、`display: flex`、`height`など、CSSレイアウトのあらゆる側面を試行錯誤しました。
    -   最終的には、グラフ領域とコンテンツパネルをそれぞれ独立した要素として扱い、コンテンツパネルを`position: absolute`で画面全体にオーバーレイ表示することで解決しました。

3.  **バックエンド連携の準備:**
    -   Notionのページ内容を取得するための新しいバックエンドAPIエンドポイント（`/api/page-content`）をNext.jsで作成しました。
    -   このAPIは、SupabaseからNotion APIキーを取得し、NotionのブロックコンテンツをMarkdown形式に変換して返すように実装しました。

4.  **フロントエンドでのMarkdown表示準備:**
    -   バックエンドから返されるMarkdownコンテンツをフロントエンドで表示するため、`react-markdown`ライブラリを導入しました。
    -   APIからのレスポンスをモック化し、フロントエンドの表示ロジックを先行して開発しました。

5.  **クローズボタンの調整:**
    -   コンテンツパネルを閉じるためのボタンが画面の端で切れてしまう問題が発生しました。
    -   ボタンの`position`と`padding`を調整することで、完全に表示されるようになりました。

### 現在の未解決の課題

現在、コンテンツ表示機能はほぼ完成していますが、一つだけ未解決の課題が残っています。

-   **無限ループの発生:** ページ内容を取得する`useEffect`内で、パネルを閉じる際に無限ループが発生しています。
    -   これは、`selectedPageId`が`null`になった際にパネルを非表示にするロジックが、`useEffect`の依存関係と再レンダリングのサイクルによって、意図せず繰り返し実行されてしまうためです。
    -   `else if (isContentPanelVisible)`という条件を追加することで解決を試みていますが、`replace`ツールが正確に適用できない問題に直面しており、これが現在のループの原因となっています。

この無限ループの問題を解決し、ページ内容表示機能を完全に動作させることが、次のステップとなります。
