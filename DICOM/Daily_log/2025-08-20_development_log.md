# 2025-08-20 DICOM-STL変換GUIアプリ開発ログ

## はじめに
本ログは、ユーザーからの「携帯動画変換くん」のようなシンプルで直感的なGUI操作で、DICOMデータから上顎骨、上顎歯列、下顎歯列、下顎管がセグメンテーションされたSTLファイルを生成するローカルアプリケーションの開発過程を記録したものです。

## 開発フェーズと主な作業内容

### フェーズ1: プロジェクトの現状把握と計画立案
- **作業内容**: 既存のDICOM処理パイプライン（`run_pipeline.sh`, `nifti_to_stl.py`, `Dockerfile`など）を分析し、GUIアプリケーション開発の実現可能性と方向性を検討しました。
- **成果**: GUIアプリ開発の全体計画を立案し、`diary/2025-08-20_gui_development_plan.md`として記録しました。

### フェーズ2: GUIの骨格と基本機能の実装
- **作業内容**: PySide6を用いて、アプリケーションの基本的なGUI骨格（ウィンドウ、入力/出力パス表示、ボタン、ログエリアなど）を`main_app.py`として作成しました。
- **成果**: 入力DICOMフォルダと出力STL保存先フォルダを選択する機能（`QFileDialog`）を実装しました。

### フェーズ3: バックエンド処理との連携と初期エラー対応
- **作業内容**: 「変換開始」ボタンから、`dcm2niix`、`nnUNetv2_predict`、`nifti_to_stl.py`の一連の処理をバックグラウンドスレッド（`QThread`）で実行するロジックを実装しました。
- **発生した問題**: `nnUNetv2_predict`の実行時に`IndexError: list index out of range`が発生しました。
- **原因**: `dcm2niix`が出力するNIfTIファイル名が、`nnUNetv2_predict`が期待する命名規則（例: `case_0000.nii.gz`）と異なっていたため、`nnUNetv2_predict`が入力ファイルを認識できませんでした。
- **解決策**: `dcm2niix`での変換後、NIfTIファイル名を`nnUNetv2_predict`が認識できる`case_0000.nii.gz`に自動でリネームする処理を`ConversionWorker`に追加しました。

### フェーズ4: nnU-Net環境設定と処理中表示の改善
- **作業内容**: `nnUNetv2_predict`実行時に発生する`nnUNet_raw is not defined`などの警告を解消し、処理中のユーザー体験を向上させました。
- **発生した問題**: `nnUNet_raw is not defined`などの警告が大量に発生し、処理中にログが更新されないため、ユーザーが処理の進行状況を把握しにくい状況でした。
- **原因**: `nnU-Net`が動作するために必要な環境変数（`nnUNet_raw`, `nnUNet_preprocessed`）が設定されていませんでした。また、`nnUNetv2_predict`は処理中にログを頻繁に出力しないため、ユーザーがフリーズしていると誤解する可能性がありました。
- **解決策**: 
    - `nnUNet_raw`と`nnUNet_preprocessed`の環境変数を自動で設定する処理を`ConversionWorker`に追加しました。
    - 処理が進行中であることを視覚的に示すため、プログレスバーの下に「AIモデル処理中...」というアニメーション表示（`QTimer`）を追加しました。

### フェーズ5: ユーザー操作性の向上とエラー対応
- **作業内容**: アプリケーションの操作性を高め、予期せぬエラーへの対応を強化しました。
- **追加機能**: 
    - **中止ボタン**: 処理中にユーザーがいつでも処理を中断できる「中止」ボタンを追加しました。
    - **GPU/CPU選択**: 処理デバイス（CPU/GPU）を選択できるラジオボタンを追加しました。特にM4 Macユーザーのために、`torch.backends.mps.is_available()`をチェックし、Apple Silicon GPU（Metal）が利用可能であれば自動で「GPU (Metal)」を選択するようにしました。
- **発生した問題**: `NameError: name 'HBoxLayout' is not defined. Did you mean: 'QHBoxLayout'?` および `NameError: name 'QQVBoxLayout' is not defined. Did you mean: 'QVBoxLayout'?` が複数回発生しました。
- **原因**: `QHBoxLayout`や`QVBoxLayout`のタイプミスが原因でした。私のコード生成時の単純なミスが繰り返されました。
- **解決策**: `replace`コマンドを使い、該当するタイプミス箇所をピンポイントで修正しました。

### フェーズ6: 複数DICOMデータ処理と出力管理
- **作業内容**: 複数のDICOMデータを効率的に処理し、出力ファイルを整理する機能を追加しました。
- **追加機能**: 
    - **複数DICOMフォルダ登録**: 最大5つのDICOMフォルダをリスト形式で登録し、順番に処理できるようにUIとバックエンドを改修しました。
    - **患者ごとの出力フォルダ**: 各DICOMフォルダの処理結果を、そのフォルダ名に`_stl`を付けたサブフォルダ内に保存するようにしました。
    - **プログレスバーの改善**: 全体の処理進捗（例: 複数DICOMフォルダのうち何番目を処理中か）をより正確に反映するようにプログレスバーの計算ロジックを調整しました。

### フェーズ7: 最終確認と技術スタック説明
- **作業内容**: これまでの機能追加と修正が正しく動作することを確認し、アプリケーションの技術的な構成を説明しました。
- **成果**: アプリケーションの主要機能が正常に動作することを確認しました。また、使用されている技術要素とその役割について詳細な説明を行いました。

## 今後の展望
本アプリケーションは基本的な機能が完成し、安定動作が確認されました。今後は、ユーザーからのフィードバックやさらなる要望に応じて、機能の追加や改善を進めていくことが可能です。例えば、処理完了後の出力フォルダ自動オープン機能、より詳細なエラーログ表示、インストーラーの作成などが考えられます。
